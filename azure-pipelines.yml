steps:
  - script: |
      python3 -m venv venv
      source venv/bin/activate
      pip install --upgrade pip
      pip install -r requirements.txt
    displayName: 'Install dependencies'

  - task: CopyFilesOverSSH@0
    inputs:
      sshEndpoint: 'MyUbuntuVM'
      sourceFolder: '$(Build.SourcesDirectory)'
      targetFolder: '/var/www/myapp'
      overwrite: true
    displayName: 'Copy files to /var/www/myapp'

  - task: SSH@0
    inputs:
      sshEndpoint: 'MyUbuntuVM'
      runOptions: 'inline'
      inline: |
        cd /var/www/myapp
        source venv/bin/activate || python3 -m venv venv && source venv/bin/activate
        pip install -r requirements.txt
        pkill -f "python app.py" || true
        nohup python app.py > app.log 2>&1 &
    displayName: 'Restart Flask app on VM'
