# azure-pipelines.yml
trigger:
  branches:
    include:
      - main   # adjust if you want 'testing' branch

pool:
  name: 'PREM-Ubuntu'   # your agent pool name
  demands:
    - agent.name -equals PREM-Ubuntu   # ensure it runs on your agent

steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.x'
    displayName: 'Set up Python'

  - script: |
      python -m venv .venv
      source .venv/bin/activate
      pip install --upgrade pip
      pip install -r requirements.txt
    displayName: 'Install dependencies'

  - script: |
      python -m pytest || echo "No tests found, skipping"
    displayName: 'Run tests'

  # Example ARM task (using your service connection ID)
  - task: AzureCLI@2
    inputs:
      azureSubscription: 'de4db89f-debf-4c55-a246-7ee625276579'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "Managing VM via ARM if needed..."
        # Example: start VM (replace with your RG and VM name)
        # az vm start --resource-group MyResourceGroup --name MyUbuntuVM

  # Deploy code to VM via SSH
  - task: CopyFilesOverSSH@0
    inputs:
      sshEndpoint: 'MyUbuntuVM'   # create SSH service connection in this project
      sourceFolder: '$(Build.SourcesDirectory)'
      targetFolder: '~/project1'
      overwrite: true
    displayName: 'Copy files to VM'

  - task: SSH@0
    inputs:
      sshEndpoint: 'MyUbuntuVM'
      runOptions: 'inline'
      inline: |
        cd ~/project1
        source ~/.venv/bin/activate || python3 -m venv ~/.venv && source ~/.venv/bin/activate
        pip install -r requirements.txt
        pkill -f "python app.py" || true
        nohup python app.py > app.log 2>&1 &
    displayName: 'Restart Flask app on VM'
