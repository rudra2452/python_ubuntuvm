trigger:
  branches:
    include:
      - main   # or 'testing' if you want to deploy from that branch

pool:
  name: 'Default'   # your agent pool
  demands:
    - agent.name -equals PREM-Ubuntu   # ensure it runs on your self-hosted agent

steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.x'
    displayName: 'Set up Python'

  - script: |
      python -m venv .venv
      source .venv/bin/activate
      pip install --upgrade pip
      pip install -r requirements.txt
    displayName: 'Install dependencies'

  - task: CopyFilesOverSSH@0
    inputs:
      sshEndpoint: 'MyUbuntuVM'   # must match the SSH service connection name in THIS project
      sourceFolder: '$(Build.SourcesDirectory)'
      targetFolder: '/var/www/myapp'   # <-- updated to your chosen directory
      overwrite: true
    displayName: 'Copy files to /var/www/myapp'

  - task: SSH@0
    inputs:
      sshEndpoint: 'MyUbuntuVM'
      runOptions: 'inline'
      inline: |
        cd /var/www/myapp
        source venv/bin/activate || python3 -m venv venv && source venv/bin/activate
        pip install -r requirements.txt
        pkill -f "python app.py" || true
        nohup python app.py > app.log 2>&1 &
    displayName: 'Restart Flask app on VM'
